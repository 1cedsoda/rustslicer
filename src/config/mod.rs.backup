//! Configuration management for print profiles

use serde::{Deserialize, Serialize};
use std::fs;
use std::path::Path;

use crate::error::{Result, SlicerError};

/// Complete print profile configuration
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct PrintProfile {
    pub metadata: Metadata,
    pub machine: MachineConfig,
    pub print_settings: PrintSettings,
    pub material: MaterialSettings,
    pub advanced: AdvancedSettings,
    pub gcode: GCodeSettings,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Metadata {
    pub profile_name: String,
    pub version: String,
    #[serde(default)]
    pub author: String,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct MachineConfig {
    pub printer_type: String,
    pub build_volume: [f64; 3],
    pub nozzle_diameter: f64,
    pub filament_diameter: f64,
    pub max_feedrate: [f64; 4],
    pub max_acceleration: [f64; 4],
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct PrintSettings {
    pub layer_height: f64,
    pub first_layer_height: f64,
    pub line_width: f64,
    pub perimeters: usize,
    pub external_perimeter_speed: f64,
    pub perimeter_speed: f64,
    pub top_solid_layers: usize,
    pub bottom_solid_layers: usize,
    pub infill_density: f64,
    pub infill_pattern: InfillPattern,
    pub infill_speed: f64,
    pub solid_infill_speed: f64,
    #[serde(default)]
    pub support_material: bool,
}

#[derive(Debug, Clone, Copy, Serialize, Deserialize, PartialEq, Eq)]
#[serde(rename_all = "lowercase")]
pub enum InfillPattern {
    Rectilinear,
    Honeycomb,
    Gyroid,
    Concentric,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct MaterialSettings {
    pub material_type: String,
    pub nozzle_temperature: u16,
    pub bed_temperature: u16,
    pub first_layer_nozzle_temp: u16,
    pub first_layer_bed_temp: u16,
    pub fan_speed: u8,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct AdvancedSettings {
    pub retraction_length: f64,
    pub retraction_speed: f64,
    #[serde(default)]
    pub retraction_z_lift: f64,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct GCodeSettings {
    #[serde(default = "default_gcode_flavor")]
    pub gcode_flavor: String,
    #[serde(default)]
    pub use_relative_e: bool,
    #[serde(default)]
    pub start_gcode: String,
    #[serde(default)]
    pub end_gcode: String,
}

fn default_gcode_flavor() -> String {
    "marlin".to_string()
}

impl PrintProfile {
    pub fn from_file<P: AsRef<Path>>(path: P) -> Result<Self> {
        let content = fs::read_to_string(path.as_ref())
            .map_err(|e| SlicerError::config(format!("Failed to read config: {}", e)))?;
        let profile: PrintProfile = toml::from_str(&content)?;
        profile.validate()?;
        Ok(profile)
    }

    pub fn validate(&self) -> Result<()> {
        if self.print_settings.layer_height <= 0.0 {
            return Err(SlicerError::config("Layer height must be positive"));
        }
        if self.print_settings.infill_density < 0.0 || self.print_settings.infill_density > 1.0 {
            return Err(SlicerError::config("Infill density must be 0.0-1.0"));
        }
        Ok(())
    }

    pub fn default_pla() -> Self {
        Self {
            metadata: Metadata {
                profile_name: "Default PLA".to_string(),
                version: "1.0".to_string(),
                author: "RustSlicer".to_string(),
            },
            machine: MachineConfig {
                printer_type: "cartesian".to_string(),
                build_volume: [220.0, 220.0, 250.0],
                nozzle_diameter: 0.4,
                filament_diameter: 1.75,
                max_feedrate: [300.0, 300.0, 12.0, 80.0],
                max_acceleration: [3000.0, 3000.0, 100.0, 5000.0],
            },
            print_settings: PrintSettings {
                layer_height: 0.2,
                first_layer_height: 0.3,
                line_width: 0.4,
                perimeters: 3,
                external_perimeter_speed: 40.0,
                perimeter_speed: 60.0,
                top_solid_layers: 4,
                bottom_solid_layers: 3,
                infill_density: 0.20,
                infill_pattern: InfillPattern::Gyroid,
                infill_speed: 80.0,
                solid_infill_speed: 60.0,
                support_material: false,
            },
            material: MaterialSettings {
                material_type: "PLA".to_string(),
                nozzle_temperature: 210,
                bed_temperature: 60,
                first_layer_nozzle_temp: 215,
                first_layer_bed_temp: 65,
                fan_speed: 100,
            },
            advanced: AdvancedSettings {
                retraction_length: 5.0,
                retraction_speed: 40.0,
                retraction_z_lift: 0.2,
            },
            gcode: GCodeSettings {
                gcode_flavor: "marlin".to_string(),
                use_relative_e: false,
                start_gcode: "G28 ; Home\nG1 Z15.0 F6000\n".to_string(),
                end_gcode: "M104 S0\nM140 S0\nM84\n".to_string(),
            },
        }
    }
}
